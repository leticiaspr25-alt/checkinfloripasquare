<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Floripa Square Check-in ULTIMATE (V6.0)</title>
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        background: '#000000',
                        surface: '#1A1A1A',
                        border: '#333333',
                        primary: '#f37021',
                        'primary-hover': '#d95d10',
                        muted: '#A3A3A3'
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>

    <style>
        /* --- ESTILOS GERAIS --- */
        body { background-color: #000000; color: white; font-family: 'Inter', sans-serif; }
        
        /* Scrollbar personalizada para Dark Mode */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        /* Animações */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }

        /* --- IMPRESSÃO BEMATECH (90x35mm - FRENTE E VERSO BLINDADO) --- */
        @media print {
            /* 1. Limpa a tela */
            body * { visibility: hidden; }
            #root, .app-container { display: none !important; }
            
            /* 2. Configura a área de impressão */
            #printable-area, #printable-area * { visibility: visible !important; }
            #printable-area {
                position: absolute; top: 0; left: 0; width: 100%;
                display: block !important;
            }

            /* 3. Configura a página física */
            html, body { margin: 0; padding: 0; background: white; height: auto; overflow: hidden; }
            
            /* 4. Estilo da Etiqueta Individual */
            .print-page {
                width: 90mm;
                height: 35mm;
                page-break-after: always; /* OBRIGATÓRIO para separar frente/verso */
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                text-align: center;
                background: white;
                color: black;
                overflow: hidden;
                border: none;
            }
            
            /* Remove quebra após a última para não soltar papel em branco */
            .print-page:last-child { page-break-after: auto; }

            /* 5. Tipografia Otimizada para Nomes Longos */
            .print-name {
                font-family: 'Arial Narrow', 'Helvetica Condensed', sans-serif;
                font-weight: 900;
                font-size: 18pt; /* Grande */
                line-height: 1;
                margin-bottom: 2mm;
                width: 88mm; /* Margem de segurança */
                white-space: nowrap; /* Não quebra linha */
                overflow: hidden; /* Corta se passar muito */
            }
            
            .print-info {
                font-family: Arial, sans-serif;
                font-size: 10pt;
                width: 88mm;
                white-space: nowrap;
                overflow: hidden;
            }

            /* 6. Definição Final de Página */
            @page { size: 90mm 35mm; margin: 0; }
        }
        
        #printable-area { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <div id="printable-area">
        <div class="print-page">
            <div class="print-name" id="p-name-1">NOME</div>
            <div class="print-info" id="p-company-1">EMPRESA</div>
        </div>
        <div class="print-page">
            <div class="print-name" id="p-name-2">NOME</div>
            <div class="print-info" id="p-company-2">EMPRESA</div>
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // --- BANCO DE DADOS LOCAL (SIMULAÇÃO SUPABASE) ---
        const DB = {
            KEYS: { USER: 'fs_user', EVENTS: 'fs_events', GUESTS: 'fs_guests', LOGS: 'fs_logs' },
            
            // Auth
            login: (email, pass) => {
                // Simulação simples: aceita qualquer senha '123456'
                if(pass === '123456') {
                    const user = { email, role: email.includes('admin') ? 'admin' : 'staff', id: Date.now() };
                    localStorage.setItem(DB.KEYS.USER, JSON.stringify(user));
                    return user;
                }
                return null;
            },
            signup: (email, pass) => {
                // Em produção, salvaria no banco. Aqui só simula sucesso.
                return true;
            },
            logout: () => localStorage.removeItem(DB.KEYS.USER),
            getUser: () => JSON.parse(localStorage.getItem(DB.KEYS.USER)),

            // Events
            getEvents: () => JSON.parse(localStorage.getItem(DB.KEYS.EVENTS) || '[]'),
            saveEvents: (data) => { 
                localStorage.setItem(DB.KEYS.EVENTS, JSON.stringify(data)); 
                window.dispatchEvent(new Event('db_update')); 
            },
            
            // Guests
            getGuests: () => JSON.parse(localStorage.getItem(DB.KEYS.GUESTS) || '[]'),
            saveGuests: (data) => { 
                localStorage.setItem(DB.KEYS.GUESTS, JSON.stringify(data)); 
                window.dispatchEvent(new Event('db_update')); 
            },

            // Logs (Histórico)
            getLogs: () => JSON.parse(localStorage.getItem(DB.KEYS.LOGS) || '[]'),
            addLog: (action, details) => {
                const user = DB.getUser();
                const logs = DB.getLogs();
                const newLog = { 
                    id: Date.now(), 
                    user: user ? user.email : 'Sistema/Guest', 
                    action, 
                    details, 
                    time: new Date().toLocaleString('pt-BR') 
                };
                localStorage.setItem(DB.KEYS.LOGS, JSON.stringify([newLog, ...logs]));
            }
        };

        // --- COMPONENTES UI (DESIGN SYSTEM) ---
        const Icon = ({ name, size=20, className }) => { 
            useEffect(() => lucide.createIcons(), [name]); 
            return <i data-lucide={name} width={size} height={size} className={className}></i>; 
        };

        const Card = ({ children, className }) => <div className={`bg-surface border border-border rounded-xl p-6 shadow-sm ${className}`}>{children}</div>;
        
        const Button = ({ children, onClick, className, variant='primary', icon, ...props }) => {
            const base = "flex items-center justify-center gap-2 px-4 py-2.5 rounded-lg font-semibold transition-all duration-200 disabled:opacity-50";
            const variants = {
                primary: "bg-primary text-white hover:bg-primary-hover shadow-lg shadow-orange-900/20",
                outline: "bg-transparent border border-gray-600 text-gray-300 hover:border-white hover:text-white",
                ghost: "text-gray-400 hover:text-white hover:bg-white/5",
                danger: "bg-red-500/10 text-red-500 border border-red-500/50 hover:bg-red-500/20"
            };
            return (
                <button onClick={onClick} className={`${base} ${variants[variant]} ${className}`} {...props}>
                    {icon && <Icon name={icon} size={18} />} {children}
                </button>
            );
        };

        const Input = ({ label, ...props }) => (
            <div className="mb-4 w-full">
                {label && <label className="block text-sm text-muted mb-2 font-medium">{label}</label>}
                <input {...props} className="w-full bg-[#111] border border-border rounded-lg px-4 py-3 text-white focus:outline-none focus:border-primary transition-colors placeholder-gray-600" />
            </div>
        );

        // Upload Component com Preview
        const UploadBox = ({ label, icon, onUpload, previewUrl }) => {
            const inputRef = useRef();
            return (
                <div 
                    className="border-2 border-dashed border-gray-700 bg-[#0a0a0a] rounded-xl h-40 flex flex-col items-center justify-center cursor-pointer hover:border-primary hover:bg-primary/5 transition-all group relative overflow-hidden"
                    onClick={() => inputRef.current.click()}
                >
                    <input type="file" hidden ref={inputRef} onChange={(e) => {
                        const file = e.target.files[0];
                        if(file) onUpload(URL.createObjectURL(file));
                    }} accept="image/*" />
                    
                    {previewUrl ? (
                        <div className="absolute inset-0 w-full h-full">
                            <img src={previewUrl} className="w-full h-full object-contain p-2" />
                            <div className="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 flex items-center justify-center transition-opacity">
                                <span className="bg-primary text-white px-3 py-1 rounded text-xs font-bold">Trocar Imagem</span>
                            </div>
                        </div>
                    ) : (
                        <div className="flex flex-col items-center gap-2 text-gray-500 group-hover:text-primary transition-colors">
                            <div className="p-3 bg-gray-800 rounded-full group-hover:bg-primary/20"><Icon name={icon} size={24} /></div>
                            <span className="text-xs font-bold uppercase tracking-widest">{label}</span>
                        </div>
                    )}
                </div>
            );
        };

        const QRCodeCanvas = ({ text }) => {
            const canvasRef = useRef();
            useEffect(() => { if(canvasRef.current && text) QRCode.toCanvas(canvasRef.current, text, { width: 250, margin: 1, color: { dark: '#000', light: '#fff' } }); }, [text]);
            return <canvas ref={canvasRef} className="rounded-xl shadow-2xl border-4 border-white" />;
        };

        // --- APLICAÇÃO PRINCIPAL ---
        const App = () => {
            const [user, setUser] = useState(DB.getUser());
            const [view, setView] = useState('loading');
            const [events, setEvents] = useState([]);
            const [currentEvent, setCurrentEvent] = useState(null);

            // Carregamento Inicial e Rotas
            useEffect(() => {
                const sync = () => setEvents(DB.getEvents());
                sync();
                window.addEventListener('db_update', sync);

                // Lógica de Roteamento (Totem, Guest, etc)
                const params = new URLSearchParams(window.location.search);
                const evtId = parseInt(params.get('event'));
                const mode = params.get('mode');

                if (evtId) {
                    const allEvents = DB.getEvents();
                    const evt = allEvents.find(e => e.id === evtId);
                    if (evt) {
                        setCurrentEvent(evt);
                        if (['totem', 'wifi', 'guest'].includes(mode)) {
                            setView(mode);
                        } else if (user) {
                            setView('manager');
                        } else {
                            setView('login');
                        }
                    } else {
                        alert('Evento não encontrado!');
                        setView(user ? 'dashboard' : 'login');
                    }
                } else if (user) {
                    setView('dashboard');
                } else {
                    setView('login');
                }

                return () => window.removeEventListener('db_update', sync);
            }, [user]);

            // Funções de Navegação
            const handleLogin = (u) => { setUser(u); setView('dashboard'); };
            const handleLogout = () => { DB.logout(); setUser(null); setView('login'); };

            // Renderização Condicional
            if (view === 'loading') return <div className="h-screen bg-black flex items-center justify-center text-primary">Carregando...</div>;
            
            // Telas Públicas (Sem Shell de Admin)
            if (view === 'totem') return <PublicTotem event={currentEvent} />;
            if (view === 'wifi') return <PublicWifi event={currentEvent} />;
            if (view === 'guest') return <PublicGuest event={currentEvent} />;

            // Telas Admin (Com Header)
            return (
                <div className="min-h-screen bg-black pb-20">
                    {view !== 'login' && (
                        <header className="border-b border-border bg-black/80 backdrop-blur sticky top-0 z-50">
                            <div className="container mx-auto px-6 h-16 flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                    <div className="w-8 h-8 bg-primary rounded flex items-center justify-center font-black text-white">F</div>
                                    <span className="font-bold text-lg tracking-tight text-white">FLORIPA SQUARE</span>
                                </div>
                                <div className="flex items-center gap-4">
                                    <span className="text-xs text-muted hidden md:block uppercase tracking-wider">{user?.email}</span>
                                    <Button variant="outline" onClick={handleLogout} className="h-8 text-xs px-3">Sair</Button>
                                </div>
                            </div>
                        </header>
                    )}

                    <main className="container mx-auto px-4 py-8">
                        {view === 'login' && <AuthScreen onLogin={handleLogin} />}
                        
                        {view === 'dashboard' && (
                            <Dashboard 
                                events={events} 
                                onCreate={(ev) => {
                                    DB.saveEvents([...events, { ...ev, id: Date.now() }]);
                                    DB.addLog('create_event', `Criou: ${ev.name}`);
                                }}
                                onSelect={(ev) => { setCurrentEvent(ev); setView('manager'); }} 
                            />
                        )}

                        {view === 'manager' && currentEvent && (
                            <EventManager 
                                event={currentEvent} 
                                onBack={() => setView('dashboard')}
                                onUpdate={(upd) => {
                                    DB.saveEvents(events.map(e => e.id === upd.id ? upd : e));
                                    setCurrentEvent(upd);
                                }}
                            />
                        )}
                    </main>
                </div>
            );
        };

        // --- TELA DE LOGIN / CADASTRO ---
        const AuthScreen = ({ onLogin }) => {
            const [isSignup, setIsSignup] = useState(false);
            const [email, setEmail] = useState('');
            const [pass, setPass] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                if(isSignup) {
                    if(DB.signup(email, pass)) {
                        alert('Conta criada com sucesso! Faça login.');
                        setIsSignup(false);
                    }
                } else {
                    const u = DB.login(email, pass);
                    if(u) onLogin(u); else alert('Senha incorreta. Use 123456');
                }
            };

            return (
                <div className="h-[calc(100vh-4rem)] flex items-center justify-center">
                    <Card className="w-full max-w-md bg-[#111] border-none shadow-2xl">
                        <div className="text-center mb-8">
                            <h1 className="text-3xl font-bold text-white mb-2">Bem-vindo</h1>
                            <p className="text-primary text-xs font-bold tracking-[0.2em] uppercase">Gestão de Eventos</p>
                        </div>
                        <div className="flex gap-4 mb-8 border-b border-gray-800">
                            <button onClick={() => setIsSignup(false)} className={`pb-3 flex-1 text-sm font-medium transition-colors ${!isSignup ? 'text-primary border-b-2 border-primary' : 'text-gray-500'}`}>Entrar</button>
                            <button onClick={() => setIsSignup(true)} className={`pb-3 flex-1 text-sm font-medium transition-colors ${isSignup ? 'text-primary border-b-2 border-primary' : 'text-gray-500'}`}>Criar Conta</button>
                        </div>
                        <form onSubmit={handleSubmit}>
                            <Input label="Email Corporativo" value={email} onChange={e=>setEmail(e.target.value)} required />
                            <Input label="Senha" type="password" value={pass} onChange={e=>setPass(e.target.value)} required />
                            {isSignup && <Input label="Confirmar Senha" type="password" required />}
                            <Button className="w-full mt-6 py-3 text-lg">{isSignup ? 'CADASTRAR' : 'ACESSAR'}</Button>
                        </form>
                        {!isSignup && <p className="text-center text-xs text-gray-600 mt-6">Senha de demonstração: 123456</p>}
                    </Card>
                </div>
            );
        };

        // --- DASHBOARD DE EVENTOS ---
        const Dashboard = ({ events, onCreate, onSelect }) => {
            const [showModal, setShowModal] = useState(false);
            const [newEvt, setNewEvt] = useState({ name: '', date: '' });

            return (
                <div className="animate-fade-in">
                    <div className="flex justify-between items-end mb-10">
                        <div>
                            <h2 className="text-3xl font-bold text-white">Eventos</h2>
                            <p className="text-muted text-sm mt-1">Gerencie seus check-ins e acessos</p>
                        </div>
                        <Button icon="plus" onClick={() => setShowModal(true)}>Novo Evento</Button>
                    </div>

                    {events.length === 0 ? (
                        <div className="text-center py-20 bg-surface rounded-xl border border-dashed border-gray-700">
                            <Icon name="calendar-x" size={48} className="text-gray-600 mx-auto mb-4" />
                            <p className="text-gray-400">Nenhum evento criado ainda.</p>
                        </div>
                    ) : (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {events.map(ev => (
                                <div key={ev.id} onClick={() => onSelect(ev)} className="group bg-surface border border-border rounded-xl p-6 cursor-pointer hover:border-primary/50 transition-all hover:shadow-2xl hover:shadow-primary/5 relative overflow-hidden">
                                    <div className="absolute top-0 right-0 p-4 opacity-0 group-hover:opacity-100 transition-opacity"><Icon name="arrow-right" className="text-primary" /></div>
                                    <div className="w-12 h-12 bg-white/5 rounded-lg flex items-center justify-center text-primary mb-4 group-hover:bg-primary group-hover:text-white transition-colors">
                                        <Icon name="calendar" />
                                    </div>
                                    <h3 className="text-xl font-bold text-white mb-1 truncate">{ev.name}</h3>
                                    <p className="text-sm text-gray-500">{new Date(ev.date).toLocaleDateString('pt-BR')}</p>
                                </div>
                            ))}
                        </div>
                    )}

                    {/* Modal Criar Evento */}
                    {showModal && (
                        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-[100] p-4">
                            <Card className="w-full max-w-md bg-[#1A1A1A]">
                                <h3 className="text-xl font-bold mb-6">Novo Evento</h3>
                                <Input label="Nome do Evento" value={newEvt.name} onChange={e=>setNewEvt({...newEvt, name:e.target.value})} autoFocus />
                                <Input label="Data" type="date" value={newEvt.date} onChange={e=>setNewEvt({...newEvt, date:e.target.value})} />
                                <div className="flex gap-3 mt-8">
                                    <Button variant="ghost" className="flex-1" onClick={() => setShowModal(false)}>Cancelar</Button>
                                    <Button className="flex-1" onClick={() => { onCreate(newEvt); setShowModal(false); }}>Criar</Button>
                                </div>
                            </Card>
                        </div>
                    )}
                </div>
            );
        };

        // --- GESTÃO DO EVENTO (O CORAÇÃO DO SISTEMA) ---
        const EventManager = ({ event, onBack, onUpdate }) => {
            const [tab, setTab] = useState('list');
            const [guests, setGuests] = useState([]);
            const [filter, setFilter] = useState('');
            const fileRef = useRef();

            // Sincronia de Guests
            useEffect(() => {
                const update = () => {
                    const all = DB.getGuests();
                    setGuests(all.filter(g => g.eventId === event.id));
                };
                update();
                window.addEventListener('db_update', update);
                return () => window.removeEventListener('db_update', update);
            }, [event.id]);

            // Funções de Lista
            const handleDownloadTemplate = () => {
                const data = [{Nome: 'Exemplo Silva', Empresa: 'Empresa X', Cargo: 'Gerente', Email: 'exemplo@email.com'}];
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Modelo");
                XLSX.writeFile(wb, "Modelo_Importacao.xlsx");
            };

            const handleImport = (file) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const wb = XLSX.read(e.target.result, {type:'array'});
                    const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                    const newGuests = json.map((r, i) => ({
                        id: Date.now() + i, eventId: event.id,
                        name: r['Nome'] || 'Sem Nome', company: r['Empresa'] || '', role: r['Cargo'] || '',
                        checkedIn: false
                    }));
                    DB.saveGuests([...DB.getGuests(), ...newGuests]);
                    DB.addLog('import', `Importou ${newGuests.length} nomes`);
                    alert(`${newGuests.length} importados!`);
                };
                reader.readAsArrayBuffer(file);
            };

            const handleExport = () => {
                const data = guests.map(g => ({
                    Nome: g.name, Empresa: g.company, Cargo: g.role, 
                    Status: g.checkedIn ? 'PRESENTE' : 'AUSENTE', Hora: g.time || '-'
                }));
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Relatorio");
                XLSX.writeFile(wb, `${event.name}_Relatorio.xlsx`);
            };

            const toggleCheckIn = (guest) => {
                const now = new Date().toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'});
                const all = DB.getGuests();
                const updated = all.map(g => g.id === guest.id ? {...g, checkedIn: !g.checkedIn, time: !g.checkedIn ? now : null} : g);
                DB.saveGuests(updated);
                if(!guest.checkedIn) DB.addLog('checkin', `Entrou: ${guest.name}`);
            };

            const printLabel = (guest) => {
                if(!guest.checkedIn) toggleCheckIn(guest);
                document.getElementById('p-name-1').innerText = guest.name;
                document.getElementById('p-company-1').innerText = guest.company;
                document.getElementById('p-name-2').innerText = guest.name;
                document.getElementById('p-company-2').innerText = guest.company;
                setTimeout(() => window.print(), 200);
            };

            // Logs
            const historyLogs = DB.getLogs(); // Pega todos (filtro simples poderia ser aplicado)

            // Render Tabs
            return (
                <div className="animate-fade-in">
                    {/* Header Interno */}
                    <div className="flex items-center gap-4 mb-8">
                        <Button variant="ghost" onClick={onBack} icon="arrow-left">Voltar</Button>
                        <h1 className="text-3xl font-bold text-white">{event.name}</h1>
                    </div>

                    {/* Tabs Navigation */}
                    <div className="flex gap-8 border-b border-border mb-8">
                        {[
                            {id: 'list', label: 'Lista de Convidados', icon: 'users'},
                            {id: 'config', label: 'Configurações', icon: 'settings'},
                            {id: 'history', label: 'Histórico', icon: 'clock'}
                        ].map(t => (
                            <button 
                                key={t.id} onClick={() => setTab(t.id)}
                                className={`flex items-center gap-2 pb-4 text-sm font-bold transition-colors border-b-2 ${tab === t.id ? 'border-primary text-primary' : 'border-transparent text-gray-500 hover:text-white'}`}
                            >
                                <Icon name={t.icon} size={18} /> {t.label}
                            </button>
                        ))}
                    </div>

                    {/* TAB: LISTA */}
                    {tab === 'list' && (
                        <div className="space-y-6">
                            {/* Métricas */}
                            <div className="grid grid-cols-2 gap-4">
                                <Card className="flex flex-col items-center py-8">
                                    <span className="text-xs font-bold uppercase tracking-widest text-gray-500">Total Convidados</span>
                                    <span className="text-5xl font-bold text-white mt-2">{guests.length}</span>
                                </Card>
                                <Card className="flex flex-col items-center py-8 bg-primary/5 border-primary/20">
                                    <span className="text-xs font-bold uppercase tracking-widest text-primary">Presentes</span>
                                    <span className="text-5xl font-bold text-primary mt-2">{guests.filter(g=>g.checkedIn).length}</span>
                                </Card>
                            </div>

                            {/* Toolbar */}
                            <div className="flex flex-col md:flex-row justify-between gap-4 bg-surface p-4 rounded-xl border border-border">
                                <div className="relative flex-1">
                                    <Icon name="search" className="absolute left-3 top-3.5 text-gray-500" size={18} />
                                    <input 
                                        className="w-full bg-black/50 border border-border rounded-lg pl-10 pr-4 py-2.5 text-white focus:outline-none focus:border-primary"
                                        placeholder="Buscar convidado..."
                                        value={filter} onChange={e=>setFilter(e.target.value)}
                                    />
                                </div>
                                <div className="flex gap-2">
                                    <input type="file" hidden ref={fileRef} onChange={e => handleImport(e.target.files[0])} />
                                    
                                    {/* BOTÃO NOVO: MODELO */}
                                    <Button variant="ghost" icon="file-spreadsheet" onClick={handleDownloadTemplate} title="Baixar Modelo CSV" />
                                    
                                    <Button variant="outline" icon="upload" onClick={() => fileRef.current.click()}>Importar</Button>
                                    <Button variant="outline" icon="download" onClick={handleExport}>Relatório</Button>
                                    <Button icon="plus" onClick={() => {
                                        const name = prompt("Nome:");
                                        if(name) {
                                            const company = prompt("Empresa:");
                                            const newG = { id: Date.now(), eventId: event.id, name, company, checkedIn: true, time: 'Manual' };
                                            DB.saveGuests([...DB.getGuests(), newG]);
                                            DB.addLog('manual_add', `Adicionou: ${name}`);
                                        }
                                    }}>Manual</Button>
                                </div>
                            </div>

                            {/* Lista Cards */}
                            <div className="space-y-3">
                                {guests.filter(g => g.name.toLowerCase().includes(filter.toLowerCase())).map(g => (
                                    <div key={g.id} className="flex items-center justify-between bg-surface border border-border p-4 rounded-lg hover:border-gray-500 transition-colors group">
                                        <div>
                                            <div className="flex items-center gap-3">
                                                <h4 className="font-bold text-lg text-white">{g.name}</h4>
                                                {g.checkedIn && <span className="bg-primary text-black text-[10px] uppercase font-bold px-2 py-0.5 rounded">Presente</span>}
                                            </div>
                                            <p className="text-sm text-gray-400">{g.company} {g.role && `• ${g.role}`}</p>
                                        </div>
                                        <div className="flex items-center gap-4">
                                            <button onClick={() => printLabel(g)} className="text-gray-500 hover:text-white p-2 rounded-full hover:bg-white/10 transition-colors" title="Imprimir Etiqueta">
                                                <Icon name="printer" />
                                            </button>
                                            <button 
                                                onClick={() => toggleCheckIn(g)}
                                                className={`w-14 h-8 rounded-full p-1 transition-colors duration-200 ease-in-out ${g.checkedIn ? 'bg-primary' : 'bg-gray-800'}`}
                                            >
                                                <div className={`w-6 h-6 bg-white rounded-full shadow-md transform transition-transform duration-200 ${g.checkedIn ? 'translate-x-6' : 'translate-x-0'}`} />
                                            </button>
                                        </div>
                                    </div>
                                ))}
                                {guests.length === 0 && <div className="text-center py-10 text-gray-500">Nenhum convidado na lista. Importe ou adicione manualmente.</div>}
                            </div>
                        </div>
                    )}

                    {/* TAB: CONFIGURAÇÕES */}
                    {tab === 'config' && (
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-8 animate-in fade-in">
                            <Card className="space-y-6">
                                <div className="flex items-center gap-3 border-b border-gray-800 pb-4">
                                    <div className="p-2 bg-primary/10 rounded text-primary"><Icon name="wifi" /></div>
                                    <div><h3 className="font-bold text-lg">Wi-Fi do Evento</h3><p className="text-xs text-muted">Exibição nas TVs</p></div>
                                </div>
                                <Input label="Nome da Rede (SSID)" value={event.wifiSSID || ''} onChange={e => onUpdate({...event, wifiSSID: e.target.value})} />
                                <Input label="Senha" value={event.wifiPass || ''} onChange={e => onUpdate({...event, wifiPass: e.target.value})} />
                                <div>
                                    <label className="block text-sm text-muted mb-2">QR Code Personalizado</label>
                                    <UploadBox label="Imagem do Wi-Fi" icon="qr-code" previewUrl={event.wifiImg} onUpload={(url) => onUpdate({...event, wifiImg: url})} />
                                </div>
                            </Card>

                            <Card className="space-y-6">
                                <div className="flex items-center gap-3 border-b border-gray-800 pb-4">
                                    <div className="p-2 bg-primary/10 rounded text-primary"><Icon name="camera" /></div>
                                    <div><h3 className="font-bold text-lg">Galeria de Fotos</h3><p className="text-xs text-muted">Acesso pós check-in</p></div>
                                </div>
                                <Input label="Link Externo" value={event.photoUrl || ''} onChange={e => onUpdate({...event, photoUrl: e.target.value})} placeholder="https://" />
                                <div>
                                    <label className="block text-sm text-muted mb-2">Imagem de Capa do Botão</label>
                                    <UploadBox label="Capa Fotos" icon="image" previewUrl={event.photoImg} onUpload={(url) => onUpdate({...event, photoImg: url})} />
                                </div>
                                
                                <div className="pt-6 mt-auto border-t border-gray-800">
                                    <label className="block text-xs font-bold text-muted uppercase tracking-widest mb-3">Links Públicos</label>
                                    <div className="grid grid-cols-2 gap-3">
                                        <Button variant="outline" icon="monitor" onClick={() => window.open(`?mode=totem&event=${event.id}`, '_blank')}>Abrir Totem</Button>
                                        <Button variant="outline" icon="tv" onClick={() => window.open(`?mode=wifi&event=${event.id}`, '_blank')}>Display TV</Button>
                                    </div>
                                </div>
                            </Card>
                        </div>
                    )}

                    {/* TAB: HISTÓRICO (NOVO) */}
                    {tab === 'history' && (
                        <Card className="p-0 overflow-hidden">
                            <table className="w-full text-left text-sm text-gray-400">
                                <thead className="bg-[#111] text-xs font-bold text-white uppercase tracking-wider">
                                    <tr>
                                        <th className="p-4">Data/Hora</th>
                                        <th className="p-4">Usuário</th>
                                        <th className="p-4">Ação</th>
                                        <th className="p-4">Detalhes</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-border">
                                    {historyLogs.map(log => (
                                        <tr key={log.id} className="hover:bg-white/5 transition-colors">
                                            <td className="p-4 whitespace-nowrap">{log.time}</td>
                                            <td className="p-4 text-white font-medium">{log.user}</td>
                                            <td className="p-4"><span className="bg-primary/10 text-primary px-2 py-1 rounded text-xs font-bold uppercase">{log.action}</span></td>
                                            <td className="p-4">{log.details}</td>
                                        </tr>
                                    ))}
                                    {historyLogs.length === 0 && <tr><td colSpan="4" className="p-8 text-center text-gray-600">Nenhum registro encontrado.</td></tr>}
                                </tbody>
                            </table>
                        </Card>
                    )}
                </div>
            );
        };

        // --- TELAS PÚBLICAS ---

        const PublicTotem = ({ event }) => (
            <div className="h-screen bg-black flex flex-col items-center justify-center p-8 text-center animate-fade-in">
                <div className="bg-white p-6 rounded-3xl shadow-[0_0_120px_rgba(243,112,33,0.4)] mb-12 transform hover:scale-105 transition-transform duration-500">
                    <QRCodeCanvas text={window.location.href.replace('totem', 'guest')} />
                </div>
                <h1 className="text-6xl font-black text-white mb-4 tracking-tighter">CHECK-IN</h1>
                <div className="h-1 w-20 bg-primary mb-6"></div>
                <p className="text-2xl text-gray-400">{event?.name}</p>
                <p className="text-sm text-gray-600 mt-12 uppercase tracking-widest animate-pulse">Aponte a câmera do seu celular</p>
            </div>
        );

        const PublicWifi = ({ event }) => (
            <div className="h-screen bg-black flex flex-col items-center justify-center text-center p-10 border-[20px] border-[#111]">
                <h1 className="text-8xl font-black text-white mb-20 tracking-tighter">WI-FI</h1>
                <div className="flex flex-row gap-20 items-center justify-center">
                    <div className="bg-white p-4 rounded-2xl shadow-2xl">
                        {event?.wifiImg ? 
                            <img src={event.wifiImg} className="w-80 h-80 object-contain" /> : 
                            <QRCodeCanvas text={event?.wifi} />
                        }
                    </div>
                    <div className="text-left space-y-10">
                        <div>
                            <p className="text-gray-500 text-sm uppercase tracking-[0.3em] mb-2 font-bold">REDE / NETWORK</p>
                            <p className="text-6xl font-bold text-white">{event?.wifiSSID || '---'}</p>
                        </div>
                        <div>
                            <p className="text-gray-500 text-sm uppercase tracking-[0.3em] mb-2 font-bold">SENHA / PASSWORD</p>
                            <p className="text-7xl font-black text-primary">{event?.wifiPass || '---'}</p>
                        </div>
                    </div>
                </div>
            </div>
        );

        const PublicGuest = ({ event }) => {
            const [step, setStep] = useState(1);
            const [name, setName] = useState('');
            const [company, setCompany] = useState('');

            const handleConfirm = () => {
                if(!name) return;
                const all = DB.getGuests();
                const exists = all.find(g => g.eventId === event.id && g.name.toLowerCase() === name.toLowerCase());
                
                if(exists) {
                    const updated = all.map(g => g.id === exists.id ? {...g, checkedIn: true, time: 'Auto'} : g);
                    DB.saveGuests(updated);
                } else {
                    const newG = { 
                        id: Date.now(), eventId: event.id, 
                        name, company: company || 'Walk-in', 
                        checkedIn: true, time: 'Auto' 
                    };
                    DB.saveGuests([...all, newG]);
                }
                DB.addLog('guest_checkin', `Auto: ${name}`);
                setStep(2);
            };

            if(step === 1) return (
                <div className="h-screen bg-black p-6 flex flex-col justify-center max-w-md mx-auto animate-fade-in">
                    <div className="text-center mb-10">
                        <div className="w-20 h-20 bg-primary/20 rounded-full mx-auto flex items-center justify-center mb-6 text-primary border-2 border-primary"><Icon name="user-check" size={40} /></div>
                        <h2 className="text-3xl font-bold text-white mb-2">Check-in</h2>
                        <p className="text-gray-400">{event?.name}</p>
                    </div>
                    
                    <div className="space-y-4">
                        <Input label="Seu Nome Completo" value={name} onChange={e=>setName(e.target.value)} autoFocus placeholder="Ex: João Silva" />
                        <Input label="Empresa (Opcional)" value={company} onChange={e=>setCompany(e.target.value)} placeholder="Ex: Floripa Square" />
                    </div>
                    
                    <Button onClick={handleConfirm} className="w-full py-4 text-lg mt-8 shadow-xl shadow-primary/20">CONFIRMAR PRESENÇA</Button>
                </div>
            );

            return (
                <div className="h-screen bg-black p-6 flex flex-col justify-center max-w-md mx-auto text-center animate-fade-in">
                    <div className="w-20 h-20 bg-green-500/20 rounded-full mx-auto flex items-center justify-center mb-6 text-green-500 border-2 border-green-500"><Icon name="check" size={40} /></div>
                    <h1 className="text-3xl font-bold text-white mb-2">Bem-vindo(a)!</h1>
                    <p className="text-gray-400 mb-12">Você está confirmado no evento.</p>

                    <div className="space-y-6">
                        {/* BOTÃO FOTOS (DESTAQUE) */}
                        <a href={event?.photoUrl} target="_blank" className="relative group block w-full bg-white text-black font-black py-6 rounded-2xl flex items-center justify-center gap-3 hover:scale-105 transition-transform shadow-[0_0_40px_rgba(255,255,255,0.3)] overflow-hidden">
                            {event?.photoImg && <img src={event.photoImg} className="absolute inset-0 w-full h-full object-cover opacity-50 group-hover:opacity-60 transition-opacity" />}
                            <div className="relative z-10 flex items-center gap-2"><Icon name="camera" size={24} /> ACESSAR FOTOS</div>
                        </a>
                        
                        {/* CARD WI-FI */}
                        <div className="bg-[#1A1A1A] border border-[#333] rounded-2xl p-8 relative overflow-hidden">
                            <div className="absolute top-0 right-0 p-4 opacity-10"><Icon name="wifi" size={100} /></div>
                            <div className="relative z-10">
                                <div className="text-primary font-bold mb-4 flex items-center justify-center gap-2"><Icon name="wifi" /> WI-FI LIBERADO</div>
                                <div className="bg-black/50 border border-white/10 rounded-lg p-4 mb-2 font-mono text-2xl text-white tracking-widest">{event?.wifiPass || '---'}</div>
                                <p className="text-xs text-gray-500 uppercase tracking-wider">Senha da Rede</p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
